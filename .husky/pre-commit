#!/bin/sh

# 1. Run lint-staged
echo "Running lint-staged..."
npx lint-staged || exit 1

# 2. Run gitleaks via Docker (skip if Docker is unavailable)
if ! docker info > /dev/null 2>&1; then
    echo "⚠️  Docker not available — skipping gitleaks scan."
else
    echo "Running gitleaks protection via Docker..."

    REPO_PATH=$(pwd)
    if [ "$OS" = "Windows_NT" ]; then
        if command -v pwd >/dev/null 2>&1; then
             if pwd -W >/dev/null 2>&1; then
                REPO_PATH=$(pwd -W)
             fi
        fi
    fi

    MSYS_NO_PATHCONV=1 docker run --rm \
        -v "$REPO_PATH:/workspace" \
        -w /workspace \
        zricethezav/gitleaks:latest \
        protect --staged -v
fi
