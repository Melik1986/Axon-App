name: Development Workflow

type: workflow

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

jobs:
  # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ (–∞–Ω–∞–ª–æ–≥ Husky pre-commit)
  code-quality:
    name: Code Quality & Security
    type: function
    config:
      node: "18"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–∏–Ω–≥–∞ (–∞–Ω–∞–ª–æ–≥ lint-staged)
      - name: Lint code
        run: |
          echo "üîç Running linting checks..."
          npm run lint
          echo "‚úÖ Linting passed"

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ TypeScript
      - name: Type check
        run: |
          echo "üîç Running TypeScript checks..."
          npm run check:types
          echo "‚úÖ Type checking passed"

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—Ç–µ—á–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥ gitleaks)
      - name: Security scan
        run: |
          echo "üîí Running security scan..."
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gitleaks
          wget -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/
          rm gitleaks.tar.gz
          
          # –°–∫–∞–Ω–∏—Ä—É–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
          gitleaks detect --source . --verbose --redact --log-level=info
          echo "‚úÖ Security scan passed"

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
      - name: Dependency audit
        run: |
          echo "üîí Running dependency audit..."
          npm audit --audit-level=high
          echo "‚úÖ Dependency audit passed"

  # –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
  development-build:
    name: Development Build
    needs: code-quality
    type: build
    params:
      platform: android
      profile: development
      buildType: 'apk'
      cache: true

  # OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  ota-update:
    name: Deploy OTA Update
    needs: development-build
    type: update
    params:
      channel: development
      message: "Dev build from ${{ github.sha }}"
      runtime-version: "1.0.0"

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–º –¥–µ–ø–ª–æ–µ
  notify-success:
    name: Notify Success
    needs: [development-build, ota-update]
    if: success()
    type: function
    steps:
      - name: Success notification
        run: |
          echo "üéâ Development workflow completed successfully!"
          echo "üì± OTA update deployed to development channel"
          echo "üîß Ready for testing new features"