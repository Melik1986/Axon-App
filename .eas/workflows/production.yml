name: Production Workflow

type: workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # –°—Ç—Ä–æ–≥–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è production
  production-quality-gate:
    name: Production Quality Gate
    type: function
    config:
      node: "18"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      # –ö—Ä–∏—Ç–∏—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–Ω—Ç–∏–Ω–≥–∞ (–∞–Ω–∞–ª–æ–≥ lint-staged)
      - name: Strict linting
        run: |
          echo "üîç Running strict linting for production..."
          npm run lint
          echo "‚úÖ Linting passed"

      # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
      - name: TypeScript validation
        run: |
          echo "üîç Running TypeScript validation..."
          npm run check:types
          echo "‚úÖ TypeScript validation passed"

      # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∞–Ω–∞–ª–æ–≥ gitleaks)
      - name: Security validation
        run: |
          echo "üîí Running production security validation..."
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º gitleaks
          wget -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/
          rm gitleaks.tar.gz
          
          # –°–∫–∞–Ω–∏—Ä—É–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ (—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º)
          gitleaks detect --source . --verbose --redact --log-level=info --exit-code=1
          echo "‚úÖ Security validation passed"

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
      - name: Production dependency audit
        run: |
          echo "üîí Running production dependency audit..."
          npm audit --audit-level=moderate
          echo "‚úÖ Dependency audit passed"

  # Production —Å–±–æ—Ä–∫–∞ –¥–ª—è iOS
  build-ios-production:
    name: Build iOS Production
    needs: production-quality-gate
    type: build
    params:
      platform: ios
      profile: production
      autoIncrement: true
      cache: true

  # Production —Å–±–æ—Ä–∫–∞ –¥–ª—è Android
  build-android-production:
    name: Build Android Production
    needs: production-quality-gate
    type: build
    params:
      platform: android
      profile: production
      autoIncrement: true
      cache: true

  # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ App Store
  submit-ios:
    name: Submit to App Store
    needs: build-ios-production
    type: submit
    params:
      platform: ios
      profile: production
      submitProfile: production

  # –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ Google Play
  submit-android:
    name: Submit to Google Play
    needs: build-android-production
    type: submit
    params:
      platform: android
      profile: production
      submitProfile: production

  # Production OTA –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  production-ota:
    name: Deploy Production OTA
    needs: [build-ios-production, build-android-production]
    type: update
    params:
      channel: production
      message: "Production release ${{ github.ref_name }}"
      runtime-version: "1.0.0"

  # –ò—Ç–æ–≥–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
  production-complete:
    name: Production Complete
    needs: [submit-ios, submit-android, production-ota]
    if: success()
    type: function
    steps:
      - name: Production success
        run: |
          echo "üéâ Production workflow completed successfully!"
          echo "üì± iOS build submitted to App Store"
          echo "ü§ñ Android build submitted to Google Play"
          echo "üöÄ OTA update deployed to production channel"